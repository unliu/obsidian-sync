## 背景
#### 需要云端存储图片
- obsidian 的图片存储，只能存储在本地（倒是可以指定当前文件夹的特定名称子文件夹），如果要发到 evf.cc 线上展示，就需要上传到文件存储系统中，比如 upyun（img.evf.cc 和 file.evf.cc 长期使用），或者 OSS。
- Obsidian 有一个 Custom Image Auto Uploader 能够实现相对较好的体验（含 Mac 和 iPhone 端），而且支持图片裁剪拉伸等等。但不支持 upyun，只支持 OSS 和 COS。
	- 原理是，把它的后端工程部署在远端服务器，然后插件请求后端工程，转发到文件存储
	- （猜想是因为 appkey 不方便存储在客户端的缘故）
	- https://github.com/haierkeys/obsidian-custom-image-auto-uploader
#### 云端存储 SSL 证书问题变严重
- CA 投票讨论，所有证书都最多续期 3 个月
- 脚本化更新域名证书、尤其是文件存储的域名证书势在必行

## 任务
- 将 upyun 的两个 bucket 迁移到阿里云  OSS 中
- 实现脚本化更新 OSS 域名证书

## 记录
### 1. 数据迁移
https://mgwnext.console.aliyun.com/cn-hangzhou/addr-manage
- 在阿里云的「数据迁移服务」中添加源地址、目标地址
- 创建迁移任务，立即执行迁移
坑点：
- 需要在阿里云创建子账号，子账号管理数据迁移；拿到子账号的 Key/Secret
- 子账号需要进行赋权

### 2. 证书脚本化
发现第三方工具 Certimate：https://github.com/certimate-go/certimate
- 只需要下载二进制，执行 `./certimate serve --http 0.0.0.0:9999` 就能启动 web 管理界面，即插即用
	- 得在服务器开 9999 端口
决定在 evf.cc 服务器上跑这个东西，每个月跑一次

后台运行：
```
怎样让`./certimate serve --http 0.0.0.0:9999` 这个命令持续在后台运行？我有安装 supervisor
```
最终把配置写在了 pyblic（/www/evf）文件夹下的 supervisor.conf 里，一并开始执行：
```shell
(venv) root@VM-8-12-ubuntu:/www/evf# /www/evf/venv/bin/supervisorctl -c supervisor.conf start certimate && /www/evf/venv/bin/supervisorctl -c supervisor.conf status
certimate: ERROR (already started)
certimate                        RUNNING   pid 262697, uptime 0:00:08
pyblic                           RUNNING   pid 3266445, uptime 242 days, 6:14:26
```

Certimate 也是一个低代码的流程引擎，不仅支持的域名服务、部署服务众多，还支持各种机器人应用，挺有意思的：
http://evf.cc:9999/#/workflows/qdf9v68cn0hdx3i
![[Pasted image 20251201232158.png]]
![[Pasted image 20250915010307.png]]
![[Pasted image 20250915010414.png]]

## 结论
SSL 证书用这种可视化管理的方式，其实是最佳实践。
当然，如果是 web 服务器本身，还是 certbot 最方便
```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d jmt.evf.cc
```

## TODO
- [ ] 明天把所有 SSL 证书都集中到这里来。
- [ ] 把 Images Auto Uploader 的 go 服务也部署到 evf.cc 上来
- [ ] 梳理一下服务器部署的最佳实践